<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống gửi đồ bằng khuôn mặt</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        input {
            font-size: 20px;
            padding: 10px 20px;
            border: 2px solid #ccc;
            border-radius: 5px;
            margin: 10px;
        }
        input:hover {
            background-color: #ccc;
        }
        canvas {
            width: 100%; /* Chiều rộng tương đương với kích thước của cửa sổ */
            height: auto; /* Chiều cao tự động điều chỉnh theo tỉ lệ khung hình */
            display: block; /* Đảm bảo canvas được vẽ toàn bộ kích thước của nó */
        }
    </style>
    <script src="mqttws31.js"></script>
  </head>
  <body onload="on_load();">
    <div id="connect">
      <input type="button" value="connect server" onclick="on_connect_server();">
      <input type="text" id="connect_input" name="connect_input" value="esp32-camera.local">
    </div>
    <div id="take">
      <input type="button" value="GIỮ ĐỒ" onclick="on_store_item();" id="store">
      <input type="button" value="LẤY ĐỒ" onclick="on_get_item();" id="get">
    </div>
    <div id="fail" style="display:none;">
      Server connection fail.
    </div>
    <div>
      <canvas id="canvas_image" width="160" height="120"></canvas>
    </div>
  </body>

  <script>
    var web_socket = null;
    var store_item = false;
    var get_item = false;
    var face_detect = false;
    var status_ = false;
    const displayMessageTimeout = 5000;
    const receiveMessageTimeout = 10000;
    var globalMessageElement;
    var messageToSend = "start_finger_";
    var topicToSend = "/topic/hungmai_wb_publish";
    var number = 0;
    // Tạo một MQTT client instance
    var client = new Paho.MQTT.Client("mqtt.eclipseprojects.io", Number(80), "/mqtt", "clientId");
    // Khi connect thành công, subscribe đến topic "/topic/hungmai_py_publish"
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    client.connect({
        onSuccess: function () {
            console.log("Connected to MQTT broker");
            client.subscribe("/topic/hungmai_py_publish");
        },
        onFailure: function (message) {
            console.log("Connection failed: " + message.errorMessage);
        }
    });

    // Hàm callback được gọi khi kết nối bị mất
    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
          console.log("Connection lost: " + responseObject.errorMessage);
          setTimeout(function() {
              client.connect({
                  onSuccess: function () {
                      console.log("Reconnected to MQTT broker");
                      client.subscribe("/topic/hungmai_py_publish");
                  },
                  onFailure: function (message) {
                      console.log("Reconnection failed: " + message.errorMessage);
                  }
              });
          }, 20); // Thử kết nối lại sau 2 giây
        }
    }

    // Hàm callback được gọi khi nhận được một message mới
    function onMessageArrived(message) {
        console.log("Received message: " + message.payloadString);
        // Bắt đầu chạy ứng dụng
        if (message.payloadString.includes("start_count_")) {
          document.getElementById('take').style.display = 'inline';
          document.getElementById('store').style.display = 'inline'; // Hiển thị lại nút "GIỮ ĐỒ"
          document.getElementById('get').style.display = 'inline'; // Hiển thị lại nút "LẤY ĐỒ"
          console.log("Chuỗi '" + "start_count_" + "' được tìm thấy trong chuỗi '" + message.payloadString + "'");
        }
        // Nhận message đã lưu image thành công, lấy id trong message và gửi đến esp32-cam
        else if (message.payloadString.includes("save_image_")) {
          console.log("Chuỗi '" + "save_image_" + "' được tìm thấy trong chuỗi '" + message.payloadString + "'");
          // Sử dụng regular expression để tìm số tự nhiên trong chuỗi
          var matches = message.payloadString.match(/\d+/);
          if (matches) {
            number = parseInt(matches[0]);
          }
          document.getElementById('store').style.display = 'none'; // Ẩn nút LẤY ĐỒ
          document.getElementById('get').style.display = 'none'; // Ẩn nút LẤY ĐỒ
          displayMessage_global("VUI LÒNG NHẬP VÂN TAY........");
          publishToDifferentTopic(messageToSend + number, topicToSend);
        }
        // Nhận message đã lưu finger thành công và hiện lại các option
        else if (message.payloadString.includes("save_finger_ok")) {
          removeMessageElement();
          console.log("Chuỗi '" + "save_finger_ok" + "' được tìm thấy trong chuỗi '" + message.payloadString + "'");
          displayMessage("THÔNG TIN CỦA BẠN ĐÃ ĐƯỢC LƯU TRỮ. CỬA ĐÃ MỞ.", 0, displayMessageTimeout);
          setTimeout(() => {
              document.getElementById('store').style.display = 'inline'; // Hiển thị lại nút "GIỮ ĐỒ"
              document.getElementById('get').style.display = 'inline'; // Hiển thị lại nút "LẤY ĐỒ"
          }, displayMessageTimeout);
        }
        // Nhận message đã lưu finger thành công và hiện lại các option
        else if (message.payloadString.includes("image_detect")) {
          removeMessageElement();
          console.log("Chuỗi '" + "image_detect" + "' được tìm thấy trong chuỗi '" + message.payloadString + "'");
          displayMessage("CỬA ĐÃ MỞ, VUI LÒNG LẤY ĐỒ!!!", 0, displayMessageTimeout);
          setTimeout(() => {
              document.getElementById('store').style.display = 'inline'; // Hiển thị lại nút "GIỮ ĐỒ"
              document.getElementById('get').style.display = 'inline'; // Hiển thị lại nút "LẤY ĐỒ"
          }, displayMessageTimeout);
        }
        // Nhận message đã lưu finger thành công và hiện lại các option
        else if (message.payloadString.includes("no_person")) {
          removeMessageElement();
          console.log("Chuỗi '" + "no_person" + "' được tìm thấy trong chuỗi '" + message.payloadString + "'");
          displayMessage("KHÔNG CÓ THÔNG TIN. VUI LÒNG THỬ LẠI!!!", 0, displayMessageTimeout);
          setTimeout(() => {
              document.getElementById('store').style.display = 'inline'; // Hiển thị lại nút "GIỮ ĐỒ"
              document.getElementById('get').style.display = 'inline'; // Hiển thị lại nút "LẤY ĐỒ"
          }, displayMessageTimeout);
        }
        else {
          console.log("Không chuỗi nào" + "' được tìm thấy trong chuỗi '" + message.payloadString + "'");
        }
    }

    function on_load()
    {
      // document.getElementById('take').style.display = 'none';
      document.getElementById('fail').style.display = 'none';
      console.log("on_load");
    }

    function on_close(event)
    {
      console.log("on_close_connection");
      // Kiểm tra xem có thể thực hiện kết nối lại hay không
      if (event.wasClean) {
        console.log(`Kết nối đã đóng clean, mã: ${event.code}, lý do: ${event.reason}`);
      } else {
        console.error('Kết nối đã bị đóng không mong muốn');
      }
      // Thực hiện kết nối lại sau một khoảng thời gian (ví dụ: sau 3 giây)
      setTimeout(connectWebSocket, 1000);
    }

    function on_open()
    {
      console.log("on_open_connection");
      // setTimeout(connectWebSocket, 3000);
    }

    function connectWebSocket()
    {
      var text = document.getElementById('connect_input');
      var connection = "ws://" + text.value + ":80/ws";
      web_socket = new WebSocket(connection);
      web_socket.binaryType = 'arraybuffer';
      web_socket.onmessage = on_message;
      web_socket.onopen = on_open;
      web_socket.onerror = on_error;
      web_socket.onclose = on_close;  // Thêm sự kiện xử lý khi kết nối đóng
    }

    function on_connect_server()
    {
      // document.getElementById('take').style.display = 'inline';
      document.getElementById('connect').style.display = 'none';
      connectWebSocket();  // Gọi hàm để kết nối WebSocket
      console.log("on_connect_server");
    }

    function on_store_item()
    {
      store_item = true;
      var text_input = "capture";
      web_socket.send(text_input);
    }

    function on_get_item()
    {
      get_item = true;
      var text_input = "capture";
      web_socket.send(text_input);
    }

    function on_error(recv_data)
    {
      console.log("on_error");
      document.getElementById('take').style.display = 'none';
      document.getElementById('fail').style.display = 'inline';
    }

    function on_close_connection() {
      console.log("on_close_connection");
      if (web_socket !== null) {
          web_socket.close();
          web_socket = null;
        }
    }

    function on_message(recv_data)
    {
      console.log(recv_data.data);
    }
  </script>
</html>
