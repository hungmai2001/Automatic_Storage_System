<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống gửi đồ bằng khuôn mặt</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        input {
            font-size: 20px;
            padding: 10px 20px;
            border: 2px solid #ccc;
            border-radius: 5px;
            margin: 10px;
        }
        input:hover {
            background-color: #ccc;
        }
        canvas {
            width: 100%; /* Chiều rộng tương đương với kích thước của cửa sổ */
            height: auto; /* Chiều cao tự động điều chỉnh theo tỉ lệ khung hình */
            display: block; /* Đảm bảo canvas được vẽ toàn bộ kích thước của nó */
        }
    </style>
    <script src="mqttws31.js"></script>
  </head>
  <body onload="on_load();">
    <div id="connect">
      <input type="button" value="connect server" onclick="on_connect_server();">
      <input type="text" id="connect_input" name="connect_input" value="esp32-camera.local">
    </div>
    <div id="take">
      <input type="button" value="GIỮ ĐỒ" onclick="on_store_item();" id="store">
      <input type="button" value="LẤY ĐỒ" onclick="on_get_item();" id="get">
    </div>
    <div id="fail" style="display:none;">
      Server connection fail.
    </div>
    <div>
      <canvas id="canvas_image" width="240" height="176"></canvas>
    </div>
  </body>

  <script>
    var web_socket = null;
    var store_item = false;
    var get_item = false;
    var face_detect = false;
    var status_ = false;
    const displayMessageTimeout = 5000;
    const receiveMessageTimeout = 10000;
    var globalMessageElement;
    var messageToSend = "start_finger_";
    var comparefinger = "compare_finger";
    var topicToSend = "/topic/hungmai_wb_publish";
    var number = 0;
    // Tạo một MQTT client instance
    var client = new Paho.MQTT.Client("mqtt.eclipseprojects.io", Number(80), "/mqtt", "myclientid_" + parseInt(Math.random() * 100, 10));
    // Khi connect thành công, subscribe đến topic "/topic/hungmai_py_publish"
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    client.connect({
        onSuccess: function () {
            console.log("Connected to MQTT broker");
            client.subscribe("/topic/hungmai_py_publish");
        },
        onFailure: function (message) {
            console.log("Connection failed: " + message.errorMessage);
        },
        timeout: 1000, // Thời gian chờ (giây) trước khi bỏ kết nối
        keepAliveInterval: 12000 // Thời gian giữ kết nối (giây)
    });

    // Hàm callback được gọi khi kết nối bị mất
    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
          console.log("Connection lost: " + responseObject.errorMessage);
          setTimeout(function() {
              client.connect({
                  onSuccess: function () {
                      console.log("Reconnected to MQTT broker");
                      client.subscribe("/topic/hungmai_py_publish");
                  },
                  onFailure: function (message) {
                      console.log("Reconnection failed: " + message.errorMessage);
                  }
              });
          }, 20); // Thử kết nối lại sau 2 giây
        }
    }

    // Hàm callback được gọi khi nhận được một message mới
    function onMessageArrived(message) {
        console.log("Received message: " + message.payloadString);
        // Bắt đầu chạy ứng dụng
        if (message.payloadString.includes("start_count_")) {
          var matches = message.payloadString.match(/\d+/);
          console.log("matches" + matches);
          if (matches) {
            number = parseInt(matches[0]);
          }
          document.getElementById('take').style.display = 'inline';
          document.getElementById('get').style.display = 'inline'; // Hiển thị lại nút "LẤY ĐỒ"
          if (number < 7)
          {
            document.getElementById('store').style.display = 'inline'; // Hiển thị lại nút "GIỮ ĐỒ"
          }
          else
          {
            document.getElementById('store').style.display = 'none'; // Hiển thị lại nút "GIỮ ĐỒ"
            displayMessage_global("HẾT CỬA. KHÔNG THỂ GIỮ ĐỒ. CHỈ CÓ THỂ LẤY ĐỒ!");
          }
          console.log("Chuỗi '" + "start_count_" + "' được tìm thấy trong chuỗi");
        }
        // Nhận message max image
        else if (message.payloadString.includes("max_image")) {
          console.log("Chuỗi '" + "max_image" + "' được tìm thấy trong chuỗi");
          // Sử dụng regular expression để tìm số tự nhiên trong chuỗi
          document.getElementById('store').style.display = 'none'; // Ẩn nút GIỮ ĐỒ
          document.getElementById('get').style.display = 'inline'; // Ẩn nút LẤY ĐỒ
          removeMessageElement();
          displayMessage_global("HẾT CỬA. KHÔNG THỂ GIỮ ĐỒ. CHỈ CÓ THỂ LẤY ĐỒ!");
        }
        // Nhận message đã lưu image thành công, lấy id trong message và gửi đến esp32-cam
        else if (message.payloadString.includes("save_image_")) {
          console.log("Chuỗi '" + "save_image_" + "' được tìm thấy trong chuỗi '" + message.payloadString + "'");
          // Sử dụng regular expression để tìm số tự nhiên trong chuỗi
          var matches = message.payloadString.match(/\d+/);
          if (matches) {
            number = parseInt(matches[0]);
          }
          document.getElementById('store').style.display = 'none'; // Ẩn nút LẤY ĐỒ
          document.getElementById('get').style.display = 'none'; // Ẩn nút LẤY ĐỒ
          displayMessage_global("VUI LÒNG NHẬP VÂN TAY........");
          publishToDifferentTopic(messageToSend + number, topicToSend);
        }
        // Nhận message đã lưu finger thành công và hiện lại các option
        else if (message.payloadString.includes("save_finger_ok")) {
          removeMessageElement();
          console.log("Chuỗi '" + "save_finger_ok" + "' được tìm thấy trong chuỗi '" + message.payloadString + "'");
          displayMessage("THÔNG TIN CỦA BẠN ĐÃ ĐƯỢC LƯU TRỮ. CỬA ĐÃ MỞ.", 0, displayMessageTimeout);
          setTimeout(() => {
              document.getElementById('store').style.display = 'inline'; // Hiển thị lại nút "GIỮ ĐỒ"
              document.getElementById('get').style.display = 'inline'; // Hiển thị lại nút "LẤY ĐỒ"
          }, displayMessageTimeout);
        }
        // Nhận message đã detect được khuôn mặt người và hiện lại các option
        else if (message.payloadString.includes("image_detect")) {
          removeMessageElement();
          console.log("Chuỗi '" + "image_detect" + "' được tìm thấy trong chuỗi '");
          displayMessage("CỬA ĐÃ MỞ, VUI LÒNG LẤY ĐỒ!!!", 0, displayMessageTimeout);
          setTimeout(() => {
              document.getElementById('store').style.display = 'inline'; // Hiển thị lại nút "GIỮ ĐỒ"
              document.getElementById('get').style.display = 'inline'; // Hiển thị lại nút "LẤY ĐỒ"
          }, displayMessageTimeout);
          get_item = false;
          status_ = false;
        }
        // Nhận message không tìm thấy khuôn mặt và gửi message đến esp32-cam để start compare fingerprint
        else if (message.payloadString.includes("no_person_fingerprint")) {
          removeMessageElement();
          console.log("Chuỗi '" + "no_person_fingerprint" + "' được tìm thấy trong chuỗi '");
          displayMessage("KHÔNG CÓ THÔNG TIN. VUI LÒNG THỬ LẠI!!!", 0, displayMessageTimeout);
          setTimeout(() => {
              document.getElementById('store').style.display = 'inline'; // Hiển thị lại nút "GIỮ ĐỒ"
              document.getElementById('get').style.display = 'inline'; // Hiển thị lại nút "LẤY ĐỒ"
          }, displayMessageTimeout);
          get_item = false;
          status_ = false;
        }
        // Nhận message không tìm thấy khuôn mặt và gửi message đến esp32-cam để start compare fingerprint
        else if (message.payloadString.includes("no_person_match")) {
          removeMessageElement();
          console.log("Chuỗi '" + "no_person_match" + "' được tìm thấy trong chuỗi '");
          displayMessage_global("VUI LÒNG NHẬP VÂN TAY ĐỂ XÁC MINH DO HÌNH ẢNH CỦA BẠN KHÔNG KHỚP........");
          publishToDifferentTopic(comparefinger, topicToSend);
        }
        else {
          console.log("Không chuỗi nào" + "' được tìm thấy trong chuỗi '");
        }
    }

    function on_load()
    {
      document.getElementById('take').style.display = 'none';
      document.getElementById('fail').style.display = 'none';
      console.log("on_load");
    }

    function on_close(event)
    {
      console.log("on_close_connection");
      // Kiểm tra xem có thể thực hiện kết nối lại hay không
      if (event.wasClean) {
        console.log(`Kết nối đã đóng clean, mã: ${event.code}, lý do: ${event.reason}`);
      } else {
        console.error('Kết nối đã bị đóng không mong muốn');
      }
      // Thực hiện kết nối lại sau một khoảng thời gian (ví dụ: sau 3 giây)
      setTimeout(connectWebSocket, 1000);
    }

    function on_open()
    {
      console.log("on_open_connection");
      // setTimeout(connectWebSocket, 3000);
    }

    function connectWebSocket()
    {
      var text = document.getElementById('connect_input');
      var connection = "ws://" + text.value + ":80/ws";
      web_socket = new WebSocket(connection);
      web_socket.binaryType = 'arraybuffer';
      web_socket.onmessage = on_message;
      web_socket.onopen = on_open;
      web_socket.onerror = on_error;
      web_socket.onclose = on_close;  // Thêm sự kiện xử lý khi kết nối đóng
    }

    function on_connect_server()
    {
      document.getElementById('take').style.display = 'none';
      document.getElementById('connect').style.display = 'none';
      connectWebSocket();  // Gọi hàm để kết nối WebSocket
      console.log("on_connect_server");
    }

    function on_store_item()
    {
      store_item = true;
      var text_input = "capture";
      web_socket.send(text_input);
    }

    function on_get_item()
    {
      get_item = true;
      var text_input = "capture";
      removeMessageElement();
      web_socket.send(text_input);
    }

    function on_error(recv_data)
    {
      console.log("on_error");
      document.getElementById('take').style.display = 'none';
      document.getElementById('fail').style.display = 'inline';
    }

    function on_close_connection() {
      console.log("on_close_connection");
      if (web_socket !== null) {
          web_socket.close();
          web_socket = null;
        }
    }
    function publishToDifferentTopic(message, topic) {
        var message = new Paho.MQTT.Message(message);
        message.destinationName = topic;
        client.send(message);
    }
    function on_message(recv_data)
    {
      // console.log(recv_data.data);
      //Get image with "Giữ Đồ" option, display it and save image if the face is detected
      if (true == store_item)
      {
        document.getElementById('store').style.display = 'none'; // Ẩn nút LẤY ĐỒ
        document.getElementById('get').style.display = 'none'; // Ẩn nút LẤY ĐỒ
        if ( (typeof(recv_data.data) == "object") && (false == face_detect) ) 
        {
          var recv_image_data = new Uint8Array(recv_data.data);
          displayImage(recv_image_data);
        }
        else if ( (typeof(recv_data.data) == "object") && (true == face_detect) ) 
        {
          // console.log("receive image");
          // console.log(recv_data.data);
          // console.log(typeof(recv_data.data));
          // console.log(recv_data.data.byteLength);
          var recv_image_data = new Uint8Array(recv_data.data);
          saveImage(recv_image_data, "image_store.png");
          clearCanvas();
          // displayMessage_global("THÔNG TIN CỦA BẠN ĐANG ĐƯỢC XỬ LÝ........");
          // displayMessage("Thông tin của bạn đã được lưu trữ", 0, displayMessageTimeout);
          // setTimeout(() => {
          //     document.getElementById('store').style.display = 'inline'; // Hiển thị lại nút "GIỮ ĐỒ"
          //     document.getElementById('get').style.display = 'inline'; // Hiển thị lại nút "LẤY ĐỒ"
          // }, displayMessageTimeout);
          face_detect = false;
          store_item = false;
        }
        else if ( (typeof(recv_data.data) == "string") && (false == face_detect) ) 
        {
          console.log("start face image");
          face_detect = true;
        }
      }
      //Get image with "Lấy Đồ" option, display it and save image if the face is detected
      else if ( (true == get_item) && (false == status_) )
      {
        // console.log("receive image 1");
        document.getElementById('store').style.display = 'none'; // Ẩn nút LẤY ĐỒ
        document.getElementById('get').style.display = 'none'; // Ẩn nút LẤY ĐỒ
        if ( (typeof(recv_data.data) == "object") && (false == face_detect) ) 
        {
          var recv_image_data = new Uint8Array(recv_data.data);
          displayImage(recv_image_data);
        }
        else if ( (typeof(recv_data.data) == "object") && (true == face_detect) ) 
        {
          // console.log("receive image");
          // console.log(recv_data.data);
          // console.log(typeof(recv_data.data));
          // console.log(recv_data.data.byteLength);
          var recv_image_data = new Uint8Array(recv_data.data);
          saveImage(recv_image_data, "image_get.png");
          clearCanvas();
          displayMessage_global("THÔNG TIN CỦA BẠN ĐANG ĐƯỢC XỬ LÝ........");
          // displayMessage_no("Thông tin của bạn đang được xử lý............", receiveMessageTimeout);
          // setTimeout(() => {
          // }, receiveMessageTimeout);
          console.log("return displayMessage");
          face_detect = false;
          status_ = true;
        }
        else if ( (typeof(recv_data.data) == "string") && (false == face_detect) ) 
        {
          console.log("start face image");
          face_detect = true;
        }
        else
        {
          console.log("===== face image");
        }
      }

      //Handle face comparison
      else if ( (true == get_item) && (typeof(recv_data.data) == "string") && (true == status_) )
      {
        console.log("receive image 2");
        console.log("Received data:", recv_data.data);
        console.log("Length of data:", recv_data.data.length);
        get_item = false;
        status_ = false;
        removeMessageElement();
        var t = recv_data.data.localeCompare("face_detected");
        console.log(t);
        if ( t == 0)
        {
          displayMessage("Đã mở tủ. Kết thúc.",0, displayMessageTimeout);
        }
        else
        {
          displayMessage("Không có dữ liệu. Kết thúc.", 0, displayMessageTimeout);
        }
        setTimeout(() => {
            document.getElementById('store').style.display = 'inline'; // Hiển thị lại nút "GIỮ ĐỒ"
            document.getElementById('get').style.display = 'inline'; // Hiển thị lại nút "LẤY ĐỒ"
        }, displayMessageTimeout);
      }
    }

    function clearCanvas()
    {
        var canvas = document.getElementById('canvas_image');
        var ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function displayMessage(message, no_timeout, timeout)
    {
      var messageElement = document.createElement('div');
      messageElement.style.fontSize = '20px';
      messageElement.style.fontWeight = 'bold';
      messageElement.style.color = 'green';
      messageElement.style.position = 'fixed';
      messageElement.style.top = '50%';
      messageElement.style.left = '50%';
      messageElement.style.transform = 'translate(-50%, -50%)';
      messageElement.innerHTML = message;

      document.body.appendChild(messageElement);
      if (no_timeout == 0)
      {
        setTimeout(() => {
            document.body.removeChild(messageElement);
        }, timeout);
      }
    }
    function displayMessage_no(message, timeout)
    {
      var messageElement = document.createElement('div');
      messageElement.style.fontSize = '20px';
      messageElement.style.fontWeight = 'bold';
      messageElement.style.color = 'green';
      messageElement.style.position = 'fixed';
      messageElement.style.top = '50%';
      messageElement.style.left = '50%';
      messageElement.style.transform = 'translate(-50%, -50%)';
      messageElement.innerHTML = message;

      document.body.appendChild(messageElement);
      setTimeout(() => {
            // document.body.removeChild(messageElement);
            var text_input = "verify";
            web_socket.send(text_input);
      }, timeout);

      globalMessageElement = messageElement;
    }
    function displayMessage_global(message)
    {
      var messageElement = document.createElement('div');
      messageElement.style.fontSize = '20px';
      messageElement.style.fontWeight = 'bold';
      messageElement.style.color = 'green';
      messageElement.style.position = 'fixed';
      messageElement.style.top = '50%';
      messageElement.style.left = '50%';
      messageElement.style.transform = 'translate(-50%, -50%)';
      messageElement.innerHTML = message;

      document.body.appendChild(messageElement);
      globalMessageElement = messageElement;
    }
    async function displayImage(pixels)
    {
      // Kích thước hình ảnh
      const xres = 240;
      const yres = 176;
      // Tạo canvas và lấy context
      const canvas = document.getElementById('canvas_image');
      const scale = 2;
      canvas.width = xres*scale;
      canvas.height = yres*scale;
      const ctx = canvas.getContext('2d');
      // Tạo một ImageData object để quản lý dữ liệu hình ảnh
      const imgData = ctx.createImageData(xres, yres);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let ln = 0;
      // Duyệt qua từng hàng và cột của hình ảnh
      for (let y = 0; y < yres; y++)
      {
          for (let x = 0; x < xres; x++)
          {
              // Tính toán chỉ số pixel trong mảng pixels
              const i = (y * xres + x) << 1;
              // Chuyển đổi từ raw data sang định dạng hình ảnh
              const pixel16 = (0xffff & pixels[i + 1]) | ((0xffff & pixels[i]) << 8);
              // Chuyển đổi màu
              imgData.data[ln + 0] = ((pixel16 >> 8) & 0xF8);   // Red
              imgData.data[ln + 1] = ((pixel16 >> 3) & 0xFC);   // Green
              imgData.data[ln + 2] = ((pixel16 << 3) & 0xF8);   // Blue
              imgData.data[ln + 3] = 255; // Alpha channel, có thể điều chỉnh nếu cần
              ln += 4; // Di chuyển đến pixel tiếp theo trong imgData
          }
      }
      // Hiển thị hình ảnh trên canvas
      ctx.putImageData(imgData, 0, 0);
    }

    async function saveImage(pixels, name_picture)
    {
      // Kích thước hình ảnh
      const xres = 240;
      const yres = 176;
      // Tạo canvas và lấy context
      const canvas = document.getElementById('canvas_image');
      const scale = 2;
      canvas.width = xres*scale;
      canvas.height = yres*scale;
      const ctx = canvas.getContext('2d');
      // Tạo một ImageData object để quản lý dữ liệu hình ảnh
      const imgData = ctx.createImageData(xres, yres);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let ln = 0;
      // Duyệt qua từng hàng và cột của hình ảnh
      for (let y = 0; y < yres; y++)
      {
          for (let x = 0; x < xres; x++)
          {
              // Tính toán chỉ số pixel trong mảng pixels
              const i = (y * xres + x) << 1;
              // Chuyển đổi từ raw data sang định dạng hình ảnh
              const pixel16 = (0xffff & pixels[i + 1]) | ((0xffff & pixels[i]) << 8);
              // Chuyển đổi màu
              imgData.data[ln + 0] = ((pixel16 >> 8) & 0xF8);   // Red
              imgData.data[ln + 1] = ((pixel16 >> 3) & 0xFC);   // Green
              imgData.data[ln + 2] = ((pixel16 << 3) & 0xF8);   // Blue
              imgData.data[ln + 3] = 255; // Alpha channel, có thể điều chỉnh nếu cần
              ln += 4; // Di chuyển đến pixel tiếp theo trong imgData
          }
      }
      ctx.putImageData(imgData, 0, 0);
      // Tạo một Blob từ dữ liệu của canvas
      return new Promise((resolve, reject) => {
        canvas.toBlob((blob) => {
          if (!blob) {
            reject(new Error('Không thể tạo Blob từ canvas'));
            return;
          }
          // Tạo một URL đặc biệt cho Blob
          const url = URL.createObjectURL(blob);
          // Tạo một thẻ <a> để tạo và tải xuống file
          const a = document.createElement('a');
          a.href = url;
          a.download = name_picture;
          document.body.appendChild(a);
          // Kích hoạt sự kiện click trên thẻ <a> để tải xuống file
          a.click();
          // Xóa thẻ <a> và giải phóng URL
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          resolve();
        }, '/png'); // Định dạng hình ảnh mong muốn (ở đây là PNG)
      });
    }
    function removeMessageElement()
    {
      if (globalMessageElement && globalMessageElement.parentNode) {
        console.log("globalMessageElement");
        globalMessageElement.parentNode.removeChild(globalMessageElement);
      }
    }
  </script>
</html>
