<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống gửi đồ bằng khuôn mặt</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        input {
            font-size: 20px;
            padding: 10px 20px;
            border: 2px solid #ccc;
            border-radius: 5px;
            margin: 10px;
        }
        input:hover {
            background-color: #ccc;
        }
        canvas {
            width: 100%; /* Chiều rộng tương đương với kích thước của cửa sổ */
            height: auto; /* Chiều cao tự động điều chỉnh theo tỉ lệ khung hình */
            display: block; /* Đảm bảo canvas được vẽ toàn bộ kích thước của nó */
        }
    </style>
  </head>
  <body onload="on_load();">
    <div id="connect">
      <input type="button" value="connect server" onclick="on_connect_server();">
      <input type="text" id="connect_input" name="connect_input" value="esp32-camera.local">
    </div>
    <div id="take">
      <input type="button" value="GIỮ ĐỒ" onclick="on_take_picture();">
      <input type="button" value="LẤY ĐỒ" onclick="on_take_picture_1();">
    </div>
    <div id="fail">
      Server connection fail.
    </div>
    <div>
      <canvas id="canvas_image" width="640" height="480"></canvas>
    </div>
  </body>

  <script>
    // https://qiita.com/magiclib/items/3aab45b6701cb973e896
    var web_socket = null;
    var giu_do = 1;
    function on_load()
    {
      document.getElementById('take').style.display = 'none';
      document.getElementById('fail').style.display = 'none';
    }

    function on_connect_server()
    {
      var text = document.getElementById('connect_input');
      console.log(text.value);
      var connection = "ws://" + text.value + ":80/ws";
      console.log(connection);

      //web_socket = new WebSocket('ws://192.168.10.161:80/ws'); // Specify server address
      web_socket = new WebSocket(connection);
      web_socket.binaryType = 'arraybuffer';
      web_socket.onmessage = on_message;
      web_socket.onerror = on_error;
      document.getElementById('take').style.display = 'inline';
      document.getElementById('connect').style.display = 'none';
    };

    function on_take_picture()
    {
      giu_do = 1;
      var text_input = "capture";
      web_socket.send(text_input);
    }

    function on_error(recv_data)
    {
      console.log("on_error");
      document.getElementById('take').style.display = 'none';
      document.getElementById('fail').style.display = 'inline';
    }

    function on_message(recv_data)
    {
      // const startTime = new Date().getTime(); 
      // console.log("on_message");
      console.log(recv_data.data);
      // console.log(typeof(recv_data.data));
      // console.log(recv_data.data.length);
      if (1 == giu_do) {
        // if (recv_data.data.length > 2) {
          console.log(recv_data.data.length);
          console.log(typeof(recv_data.data));
          var recv_image_data = new Uint8Array(recv_data.data);
          console.log(recv_image_data);
          displayImage(recv_image_data);
        // }
        // else {
        //   /* Do nothing */
        // }
      }
      else {
        /* Do nothing */
      }
      // const endTime = new Date().getTime();
      // const timeTaken = endTime - startTime;
      // console.log("Function took " + timeTaken + " milliseconds");
    }

    async function displayImage(pixels) {
      // Kích thước hình ảnh
      const xres = 320;
      const yres = 240;
      
      // Tạo canvas và lấy context
      const canvas = document.getElementById('canvas_image');
      const scale = 2;
      canvas.width = xres*scale;
      canvas.height = yres*scale;
      const ctx = canvas.getContext('2d');

      // Tạo một ImageData object để quản lý dữ liệu hình ảnh
      const imgData = ctx.createImageData(xres, yres);

      let ln = 0;

      // Duyệt qua từng hàng và cột của hình ảnh
      for (let y = 0; y < yres; y++) {
          for (let x = 0; x < xres; x++) {
              // Tính toán chỉ số pixel trong mảng pixels
              const i = (y * xres + x) << 1;

              // Chuyển đổi từ raw data sang định dạng hình ảnh
              const pixel16 = (0xffff & pixels[i + 1]) | ((0xffff & pixels[i]) << 8);

              // Chuyển đổi màu
              imgData.data[ln + 0] = ((((pixel16 >> 11) & 0x1F) * 527) + 23) >> 6;
              imgData.data[ln + 1] = ((((pixel16 >> 5) & 0x3F) * 259) + 33) >> 6;
              imgData.data[ln + 2] = (((pixel16 & 0x1F) * 527) + 23) >> 6;
              imgData.data[ln + 3] = 255; // Alpha channel, có thể điều chỉnh nếu cần

              ln += 4; // Di chuyển đến pixel tiếp theo trong imgData
          }
      }

      // Hiển thị hình ảnh trên canvas
      ctx.putImageData(imgData, 0, 0);

      // Thêm canvas vào body (hoặc bất kỳ phần tử HTML nào bạn muốn hiển thị)
      document.body.appendChild(canvas);
    }
  </script>
</html>
